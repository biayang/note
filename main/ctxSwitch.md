# CPU 上下文切换  
  
## 概念  
CPU在不同的任务之前切换需要保存任务的运行资源记录：CPU得知道从哪里去加载任务，又从哪里开始运行所以需要用到CPU寄存器和程序计数器。
在理解上面的基础上CPU上下文切换就是保存上一个任务运行的寄存器和计数器(Program Counter, PC)信息切换到加载下一个任务的寄存器和计数器的过程。  
根据任务的不同，CPU上线文切换分为以下三个场景类型。
  
## 类型  
进程上下文切换  
线程上下文切换  
中断上下文切换  
  
## 进程上下文切换  
### 概念  
从用户态到内核态的转变成为系统调用。即：在发生系统调用的时候会触发两次CPU上下文切换，从用户态 -》 内核态 和 内核态 -》 用户态  
### 系统调用和进程上下文切换的区别  
系统调用都是在同一个进程中发生  
进程上下文切换是从一个进程切换到第二个进程中运行  
进程上下文切换除了需要保存 虚拟内存，栈，全局变量 等用户空间的资源，还包括 内核堆栈，寄存器等内核空间的状态  
### 触发进程调度的情景  
进程时间片用完，系统进行调度  
进程申请的系统资源不足（比如内存不足）  
调用 Sleep 函数主动挂起进程  
当有优先级更高的进程运行时，CPU上的进程会被挂起  
  
## 线程上下文切换  
### 线程与进程的区别  
线程是调度的基本单位，进程是资源拥有的基本单位 通俗理解：系统内核中的任务调度实际上调度的对象是线程，而进程只是给线程提供了虚拟内存，全局变量等资源这些资源在线程上下文切换时是不需要修改的  
  
## 中断上下文切换  
中断优先级会打断进程的正常调度和执行    
对于同一个CPU来说，中断处理比进程拥有更高的优先级  

## 实战
### [ vmstat ](src/cmd/vmstat.md) `vmstat 5`
### pidstat: `pidstat -w 5`
- cswch     自愿上下文切换，指进程无法获取所需资源，导致上下文切换。如IO，内存等系统资源不足，进而自愿上下文切换。
- nvcswch   非自愿上下文切换，指进程由于时间片已到等原因，被系统强制调度，进而发生上下文切换。

### sysbench    多线程基准测试工具，一般用来评估不同系统参数下DB负载情况。